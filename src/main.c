
#include <stdbool.h>
#include <stdio.h>
#include <stdlib.h>

#include "utils.h"
#include "string.h"
#include "sylk.h"


#define print_help() \
{ \
    printf("usage: %s <file_name> [-a] [-b] [-h]\n", argv[0]); \
    printf("help:\n"); \
    printf("\t<file_name> : file with code to execute\n"); \
    printf("\t-a          : dump the abstract syntax tree\n"); \
    printf("\t-b          : dump the generated bytecodes\n"); \
    printf("\t-h          : not execute the program\n"); \
}

int main(int argc, char* argv[]) {
    if (argc < 2) {
        print_help();
        return 1;
    }

    bool print_ast = false;
    bool print_bytecode = false;
    bool halt_program = false;

    // parse flags
    int index = 2;
    while (index < argc) {
        const char* current_arg = argv[index];
        if (strlen(current_arg) != 2) {
            print_help();
            return 1;
        }

        if (current_arg[0] != '-') {
            print_help();
            return 1;
        }

        switch (current_arg[1]) {
            case 'a':
                print_ast = true;
                break;

            case 'b':
                print_bytecode = true;
                break;

            case 'h':
                halt_program = true;
                break;
            default:
                print_help();
                return 1;
        }

        ++index;
    }

    (void) print_bytecode;
    (void) halt_program;

    struct sylk_config config = {
        .print_ast = print_ast,
        .print_bytecode = print_bytecode,
        .halt_program = halt_program
    };

    struct sylk* s = sylk_new(&config);

    sylk_load_prelude(s);
    CHECK(sylk_run_file(s, argv[1]), "failed to run file");
    sylk_free(s);
}
